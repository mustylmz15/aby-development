<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Etkileşimli Lokal Harita Projesi</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .project-selector-container { position: absolute; top: 10px; right: 80px; z-index: 1; background: white; padding: 10px 15px; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.2); display: flex; align-items: center; }
        .project-selector-container label { margin-right: 10px; font-weight: bold; font-size: 14px; color: #333; }
        .project-selector-container select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .custom-popup .maplibregl-popup-content { padding: 15px; background: #ffffff; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 14px; color: #333; }
        .custom-popup h3 { margin: 0 0 10px; color: #2c3e50; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .custom-popup ul { list-style: none; margin: 0; padding: 0; }
        .custom-popup li { margin-bottom: 5px; }
        .custom-popup li strong { color: #e74c3c; margin-right: 5px; }
        .custom-popup li strong.district-data { color: #3498db; }
        .custom-popup li strong.local-data { color: #2ecc71; }
        .custom-popup li strong.point-data { color: #2c3e50; }
    </style>
</head>
<body>
    <div class="project-selector-container">
        <label for="project-select">Proje Seçimi:</label>
        <select name="projects" id="project-select">
            <option value="">Proje Seçiniz...</option>
            <option value="kgys">KGYS Projesi</option>
        </select>
    </div>
    <div id='map'></div>
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <script>
        // --- Demo Veri Setleri ---
        const kgysIlVerileri = { 'Malatya': { sabitKamera: 1000, hareketliKamera: 500, switch: 500, ups: 500 } };
        const kgysIlceVerileri = { 'Akçadağ': { sabitKamera: 300, hareketliKamera: 150, switch: 150, ups: 150 } };
        const kgysYerelVerileri = { 'Kültür Mahallesi': {} }; // Kültür Mahallesinin kendisi için veri yok, sadece içindeki A noktası için var.
        const kgysNoktaVerileri = { 'Akçadağ Yolu Belediye Önü': { sabitKamera: 2, hareketliKamera: 1, switch: 1, ups: 1 } };
        const kgysNoktaGeoJSON = { 'type': 'FeatureCollection', 'features': [ { 'type': 'Feature', 'geometry': { 'type': 'Point', 'coordinates': [37.9985, 38.3440] }, 'properties': { 'name': 'Akçadağ Yolu Belediye Önü' } } ] };

        const map = new maplibregl.Map({
            container: 'map', center: [35.2, 38.9], zoom: 5.5,
            style: {
                version: 8, glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
                sources: {
                    'osm-polygons': { type: 'vector', tiles: ['http://localhost:18080/planet_osm_polygon/{z}/{x}/{y}'] },
                    'osm-lines': { type: 'vector', tiles: ['http://localhost:18080/planet_osm_line/{z}/{x}/{y}'] },
                    'osm-points': { type: 'vector', tiles: ['http://localhost:18080/planet_osm_point/{z}/{x}/{y}'] },
                    'kgys-noktalar-kaynak': { type: 'geojson', data: kgysNoktaGeoJSON }
                },
                layers: [
                    { id: 'background', type: 'background', paint: { 'background-color': '#f8f4f0' } },
                    { id: 'water', source: 'osm-polygons', 'source-layer': 'planet_osm_polygon', type: 'fill', filter: ['any', ['has', 'waterway'], ['==', 'natural', 'water']], paint: { 'fill-color': '#a0c8f0' } },
                    { 'id': 'roads-minor', 'source': 'osm-lines', 'source-layer': 'planet_osm_line', 'type': 'line', 'minzoom': 12, 'filter': ['in', 'highway', 'tertiary', 'residential', 'service', 'unclassified'], 'paint': { 'line-color': '#ffffff', 'line-width': ['interpolate', ['linear'], ['zoom'], 12, 0.5, 16, 4] } },
                    { 'id': 'roads-major', 'source': 'osm-lines', 'source-layer': 'planet_osm_line', 'type': 'line', 'filter': ['in', 'highway', 'motorway', 'trunk', 'primary', 'secondary'], 'paint': { 'line-color': '#f2d87e', 'line-width': ['interpolate', ['linear'], ['zoom'], 5, 0.8, 12, 2.5] } },
                    { 'id': 'district-boundaries', 'source': 'osm-lines', 'source-layer': 'planet_osm_line', 'type': 'line', 'minzoom': 9, 'filter': ['all', ['==', 'boundary', 'administrative'], ['==', 'admin_level', '6']], 'paint': { 'line-color': '#8e9eab', 'line-width': 1.4, 'line-dasharray': [3, 3] } },
                    { 'id': 'province-boundaries', 'source': 'osm-lines', 'source-layer': 'planet_osm_line', 'type': 'line', 'filter': ['all', ['==', 'boundary', 'administrative'], ['==', 'admin_level', '4']], 'paint': { 'line-color': '#6c7a89', 'line-width': 2, 'line-dasharray': [3, 2] } },
                    { 'id': 'province-name-labels', 'source': 'osm-points', 'source-layer': 'planet_osm_point', 'type': 'symbol', 'minzoom': 4, 'maxzoom': 8.5, 'filter': ['==', 'place', 'city'], 'layout': { 'text-field': ['get', 'name'], 'text-font': ['Noto Sans Bold'], 'text-size': 14 }, 'paint': { 'text-color': '#2c3e50', 'text-halo-color': 'white', 'text-halo-width': 2 } },
                    { 'id': 'district-name-labels', 'source': 'osm-points', 'source-layer': 'planet_osm_point', 'type': 'symbol', 'minzoom': 8.5, 'maxzoom': 11, 'filter': ['==', 'place', 'town'], 'layout': { 'text-field': ['get', 'name'], 'text-font': ['Noto Sans Bold'], 'text-size': 12 }, 'paint': { 'text-color': '#34495e', 'text-halo-color': 'white', 'text-halo-width': 1.5 } },
                    { 'id': 'other-place-labels', 'source': 'osm-points', 'source-layer': 'planet_osm_point', 'type': 'symbol', 'minzoom': 11, 'filter': ['in', 'place', 'village', 'suburb', 'hamlet', 'quarter', 'neighbourhood'], 'layout': { 'text-field': ['get', 'name'], 'text-font': ['Noto Sans Regular'], 'text-size': 10 }, 'paint': { 'text-color': '#555', 'text-halo-color': 'white', 'text-halo-width': 1 } },
                    { 'id': 'road-name-labels', 'type': 'symbol', 'source': 'osm-lines', 'source-layer': 'planet_osm_line', 'minzoom': 14, 'filter': ['has', 'name'], 'layout': { 'symbol-placement': 'line', 'text-field': ['get', 'name'], 'text-font': ['Noto Sans Regular'], 'text-size': 10, 'text-pitch-alignment': 'viewport', 'text-rotation-alignment': 'map' }, 'paint': { 'text-color': '#767676', 'text-halo-color': '#ffffff', 'text-halo-width': 1.5 } }
                ]
            }
        });

        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        map.on('load', () => {
            const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false, className: 'custom-popup' });
            map.addLayer({ id: 'kgys-provinces', type: 'circle', source: 'osm-points', 'source-layer': 'planet_osm_point', filter: ['all', ['==', 'place', 'city'], ['!=', 'name', 'Kocaeli']], paint: { 'circle-color': '#e74c3c', 'circle-radius': 8, 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }, layout: { 'visibility': 'none' } });
            map.addLayer({ id: 'kgys-districts', type: 'circle', source: 'osm-points', 'source-layer': 'planet_osm_point', filter: ['==', 'place', 'town'], paint: { 'circle-color': '#3498db', 'circle-radius': 6, 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }, layout: { 'visibility': 'none' } });
            map.addLayer({ id: 'kgys-local', type: 'circle', source: 'osm-points', 'source-layer': 'planet_osm_point', filter: ['in', 'place', 'village', 'suburb', 'hamlet', 'quarter', 'neighbourhood'], paint: { 'circle-color': '#2ecc71', 'circle-radius': 5, 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }, layout: { 'visibility': 'none' } });
            map.addLayer({ id: 'kgys-noktalar', type: 'circle', source: 'kgys-noktalar-kaynak', paint: { 'circle-color': '#2c3e50', 'circle-radius': 7, 'circle-stroke-width': 2, 'circle-stroke-color': '#ffffff' }, layout: { 'visibility': 'none' } });

            // Tıklama Olayları
            map.on('click', 'kgys-provinces', (e) => {
                const f = e.features[0];
                map.flyTo({ center: f.geometry.coordinates.slice(), zoom: 9.5, speed: 1.2 });
                map.setFilter('kgys-provinces', ['all', ['==', 'place', 'city'], ['!=', 'name', 'Kocaeli'], ['!=', 'name', f.properties.name]]);
                map.setLayoutProperty('kgys-districts', 'visibility', 'visible');
                map.setFilter('kgys-districts', ['==', 'place', 'town']);
                map.setLayoutProperty('kgys-local', 'visibility', 'none');
                map.setLayoutProperty('kgys-noktalar', 'visibility', 'none');
            });
            map.on('click', 'kgys-districts', (e) => {
                const f = e.features[0];
                map.flyTo({ center: f.geometry.coordinates.slice(), zoom: 12.5, speed: 1.2 });
                map.setFilter('kgys-districts', ['all', ['==', 'place', 'town'], ['!=', 'name', f.properties.name]]);
                map.setLayoutProperty('kgys-local', 'visibility', 'visible');
                map.setLayoutProperty('kgys-noktalar', 'visibility', 'visible');
            });
            map.on('click', 'kgys-local', (e) => {
                const f = e.features[0];
                map.flyTo({ center: f.geometry.coordinates.slice(), zoom: 15, speed: 1.2 });
                map.setFilter('kgys-local', ['all', ['in', 'place', 'village', 'suburb', 'hamlet', 'quarter', 'neighbourhood'], ['!=', 'name', f.properties.name]]);
            });
             map.on('click', 'kgys-noktalar', (e) => {
                 map.flyTo({ center: e.features[0].geometry.coordinates.slice(), zoom: 16, speed: 1.2 });
            });
            
            // Zoom ve Proje Seçim menüsü olayları
            map.on('zoom', () => {
                const ps = document.getElementById('project-select');
                if (ps.value !== 'kgys') return;
                const z = map.getZoom();
                if (z < 9.0) {
                    map.setLayoutProperty('kgys-provinces', 'visibility', 'visible');
                    map.setFilter('kgys-provinces', ['all', ['==', 'place', 'city'], ['!=', 'name', 'Kocaeli']]);
                    map.setLayoutProperty('kgys-districts', 'visibility', 'none');
                    map.setLayoutProperty('kgys-local', 'visibility', 'none');
                    map.setLayoutProperty('kgys-noktalar', 'visibility', 'none');
                } else if (z >= 9.0 && z < 12.0) {
                    map.setLayoutProperty('kgys-provinces', 'visibility', 'none');
                    map.setLayoutProperty('kgys-districts', 'visibility', 'visible');
                    map.setFilter('kgys-districts', ['==', 'place', 'town']);
                    map.setLayoutProperty('kgys-local', 'visibility', 'none');
                    map.setLayoutProperty('kgys-noktalar', 'visibility', 'none');
                } else if (z >= 12.0) {
                    map.setLayoutProperty('kgys-provinces', 'visibility', 'none');
                    map.setLayoutProperty('kgys-districts', 'visibility', 'none');
                    map.setLayoutProperty('kgys-local', 'visibility', 'visible');
                    map.setLayoutProperty('kgys-noktalar', 'visibility', 'visible');
                }
            });

            const projectSelect = document.getElementById('project-select');
            projectSelect.addEventListener('change', (e) => {
                const z = map.getZoom();
                if (e.target.value === 'kgys') {
                    if(z < 9.0) map.setLayoutProperty('kgys-provinces', 'visibility', 'visible');
                    else if (z >= 9.0 && z < 12.0) map.setLayoutProperty('kgys-districts', 'visibility', 'visible');
                    else {
                        map.setLayoutProperty('kgys-local', 'visibility', 'visible');
                        map.setLayoutProperty('kgys-noktalar', 'visibility', 'visible');
                    }
                } else {
                    map.setLayoutProperty('kgys-provinces', 'visibility', 'none');
                    map.setLayoutProperty('kgys-districts', 'visibility', 'none');
                    map.setLayoutProperty('kgys-local', 'visibility', 'none');
                    map.setLayoutProperty('kgys-noktalar', 'visibility', 'none');
                }
            });
            
            // Fare Olayları
            const clickableLayers = ['province-name-labels', 'district-name-labels', 'kgys-provinces', 'kgys-districts', 'kgys-local', 'kgys-noktalar'];
            clickableLayers.forEach(layer => {
                map.on('mouseenter', layer, (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    let data, name, htmlContent;
                    
                    if (layer === 'kgys-provinces') {
                        name = e.features[0].properties.name;
                        data = kgysIlVerileri[name];
                        if (data) { htmlContent = `<h3>${name} KGYS Detayları</h3><ul><li><strong>${data.sabitKamera}</strong> Sabit Kamera</li><li><strong>${data.hareketliKamera}</strong> Hareketli Kamera</li><li><strong>${data.switch}</strong> Switch</li><li><strong>${data.ups}</strong> UPS</li></ul>`; }
                    } else if (layer === 'kgys-districts') {
                        name = e.features[0].properties.name;
                        data = kgysIlceVerileri[name];
                        if (data) { htmlContent = `<h3>${name} KGYS Detayları</h3><ul><li><strong class="district-data">${data.sabitKamera}</strong> Sabit Kamera</li><li><strong class="district-data">${data.hareketliKamera}</strong> Hareketli Kamera</li><li><strong class="district-data">${data.switch}</strong> Switch</li><li><strong class="district-data">${data.ups}</strong> UPS</li></ul>`; }
                    } else if (layer === 'kgys-local') {
                        name = e.features[0].properties.name;
                        data = kgysYerelVerileri[name];
                        if (data) { /* Mahalleler için genel popup şimdilik yok */ }
                    } else if (layer === 'kgys-noktalar') {
                        name = e.features[0].properties.name;
                        data = kgysNoktaVerileri[name];
                        if (data) { htmlContent = `<h3>${name}</h3><ul><li><strong class="point-data">${data.sabitKamera}</strong> Sabit Kamera</li><li><strong class="point-data">${data.hareketliKamera}</strong> Hareketli Kamera</li><li><strong class="point-data">${data.switch}</strong> Switch</li><li><strong class="point-data">${data.ups}</strong> UPS</li></ul>`; }
                    }

                    if (htmlContent) {
                        popup.setLngLat(e.lngLat).setHTML(htmlContent).addTo(map);
                    }
                });
                map.on('mouseleave', layer, () => {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });
            });
        });
    </script>
</body>
</html>